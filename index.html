<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎮 다빈치 코드 게임</title>
    <style>
        @import url('style.css');
    </style>
</head>
<body>
    <!-- 게임 화면 -->
    <div id="gameScreen" class="screen active">
        <header>
            <div class="header-content">
                <div class="game-title">🎮 다빈치 코드</div>
                <div class="game-info">
                    <div class="info-item">
                        <span class="info-label">턴:</span>
                        <span class="info-value" id="turnCount">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">맞춘 카드:</span>
                        <span class="info-value" id="correctCount">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">가능한 덱:</span>
                        <span class="info-value" id="possibleDecks">-</span>
                    </div>
                </div>
                <div class="controls">
                    <button onclick="initGame()">🎲 새 게임</button>
                    <button onclick="showRankingScreen()">🏆 랭킹</button>
                    <button onclick="testGenerateDeck()" id="testDeckBtn" disabled>🔍 분석</button>
                    <button onclick="logout()" id="logoutBtn" style="display:none;">로그아웃</button>
                </div>
                <div class="player-welcome" id="playerWelcome" aria-live="polite"></div>
            </div>
        </header>

        <div class="game-container">
            <div class="opponent-area">
                <div class="opponent-label">
                    <span>🤖</span>
                    <span>AI의 카드</span>
                </div>
                <div class="opponent-deck" id="opponentDeck"></div>
            </div>

            <div class="center-area">
                <div class="turn-indicator" id="turnIndicator">게임을 시작하세요</div>
            </div>

            <div class="player-area">
                <div class="action-area">
                    <button class="action-btn btn-pass" onclick="passTurn()" id="passBtn" disabled>
                        ⏭️ 턴 넘기기
                    </button>
                </div>
                <div class="player-label">
                    <span>👤</span>
                    <span>내 카드</span>
                </div>
                <div class="player-deck" id="playerDeck"></div>
            </div>
        </div>
    </div>

    <!-- 랭킹 화면 -->
    <div id="rankingScreen" class="screen">
        <header>
            <div class="header-content">
                <div class="game-title">🏆 랭킹</div>
                <div class="controls">
                    <button onclick="showGameScreen()">🎮 게임으로 돌아가기</button>
                </div>
            </div>
        </header>

        <div class="ranking-container">
            <div class="ranking-header">
                <h1>🏆 명예의 전당</h1>
            </div>

            <div class="ranking-stats">
                <div class="stat-card">
                    <div class="stat-icon">👑</div>
                    <div class="stat-label">1위</div>
                    <div class="stat-value" id="topPlayer">-</div>
                    <div class="stat-sub" id="topTurns">- 턴</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">📊</div>
                    <div class="stat-label">총 게임 수</div>
                    <div class="stat-value" id="totalGames">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">⚡</div>
                    <div class="stat-label">평균 턴</div>
                    <div class="stat-value" id="avgTurns">-</div>
                </div>
            </div>

            <div class="ranking-table-wrapper">
                <table class="ranking-table">
                    <thead>
                        <tr>
                            <th width="80">순위</th>
                            <th>닉네임</th>
                            <th width="100">턴 수</th>
                            <th width="120">날짜</th>
                        </tr>
                    </thead>
                    <tbody id="rankingTableBody">
                        <tr>
                            <td colspan="4" style="text-align:center; padding:40px;">
                                아직 랭킹 기록이 없습니다
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- <div class="ranking-footer">
                <button class="clear-ranking-btn" onclick="clearRankings()">🗑️ 랭킹 초기화</button>
            </div> -->
        </div>
    </div>

    <!-- 기존 모달들 -->
    <div class="joker-placement-modal" id="jokerModal">
        <div class="joker-modal-content">
            <h3>🃏 조커를 배치할 위치를 선택하세요</h3>
            <div class="position-grid" id="positionGrid"></div>
        </div>
    </div>

    <div class="number-selection-modal" id="numberModal">
        <div class="number-modal-content">
            <div class="number-selector" id="numberSelector">
                <h3>예측할 숫자를 선택하세요</h3>
                <div class="number-grid" id="numberGrid"></div>
                <div class="joker-button-container">
                    <button class="joker-btn" id="jokerBtn">🃏 조커</button>
                </div>
                <button class="cancel-btn" onclick="cancelSelection()">취소</button>
            </div>
        </div>
    </div>

    <div class="game-over-modal" id="gameOverModal">
        <div class="modal-content">
            <div class="winner-icon" id="winnerIcon"></div>
            <h2 id="winnerText"></h2>
            <p id="winnerMessage"></p>
            <button onclick="closeModal()" style="padding: 15px 50px; font-size: 1.2em;">확인</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>
    <div class="toast-log" id="toastLog" aria-live="polite"></div>

    <div id="loginModal" class="modal">
        <div class="modal-overlay"></div>
        <div class="modal-box">
            <div class="login-box">
                <h2>로그인</h2>
                <p>계정으로 로그인하면 게임을 시작할 수 있습니다.</p>
                <div class="input-row">
                    <input id="studentNumberInput" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="학번 (예: 10101)" aria-label="학번 입력" />
                </div>
                <div class="input-row">
                    <input id="nameInput" type="text" placeholder="이름" autocomplete="name" aria-label="이름 입력" />
                </div>
                <div class="input-row">
                    <input id="nicknameInput" type="text" placeholder="랭킹에 표시될 닉네임" aria-label="닉네임 입력" />
                </div>
                <div class="login-actions">
                    <button id="loginButton">로그인</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase 먼저 초기화 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, deleteDoc } 
            from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCtvxpEpR15gr2CRoH_Gjk6AAA3EiXzNGU",
            authDomain: "davincicode-770b9.firebaseapp.com",
            projectId: "davincicode-770b9",
        };

        // Firebase 초기화
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // 전역으로 접근 가능하도록 설정
        window.firebaseApp = app;
        window.db = db;
        window.firebaseModules = {
            collection,
            addDoc,
            query,
            orderBy,
            limit,
            getDocs,
            deleteDoc
        };

        console.log('✅ Firebase 초기화 완료');

        // Firebase 초기화 후 game.js 로드
        const script = document.createElement('script');
        script.src = 'game.js';
        script.onload = () => console.log('✅ game.js 로드 완료');
        script.onerror = () => console.error('❌ game.js 로드 실패');
        document.body.appendChild(script);
    </script>
</body>
</html>